import{J as N,K as me,a as y,u as pe,q as _e,s as U,b as l,c as L,e as q,f as A,h as w,v as M,t as u,m as S,i as e,l as i,B as I,L as T,F as C,x as P,C as O,S as J}from"./index.c3b8df4f.js";import{_ as ve}from"./LayoutAuthenticatedX.b8bb81e8.js";import{_ as he}from"./SectionMain.13d65fb7.js";import{_ as fe}from"./NotificationBar.705d3c1c.js";import{B as be}from"./BaseTable.4f3dd512.js";import{_ as ye}from"./CardBox.b2ca2ff4.js";import{_ as ge}from"./SectionTitleLineWithButton.e58ee057.js";import{_ as D}from"./BaseButton.db2641b8.js";import{p as we,c as xe,u as ke,v as Se,h as Ie,y as Ce,z as Pe}from"./mdi.aa269c9f.js";import{A as E}from"./index.c4cb3088.js";import{u as $e}from"./supplier.19d2b04d.js";import{u as Ae}from"./warehouse.1b36c818.js";import{u as Be}from"./item.4bada906.js";import"./darkMode.be9f2000.js";import"./BaseIcon.7a5ae775.js";import"./FormControl.f0dd7a4c.js";import"./FooterBar.9f5e8a1a.js";import"./logo.c6f18b48.js";import"./BaseLevel.3eae5b81.js";import"./TableCheckboxCell.7896a874.js";import"./BaseButtons.b6e87254.js";import"./_plugin-vue_export-helper.c27b6911.js";const F={async create(n){return(await N.post(`${E}/procurements`,n)).data},async getById(n){return(await N.get(`${E}/procurements/${n}`)).data},async updateById(n,f){return(await N.put(`${E}/procurements/${n}`,f)).data},async delete(n){return(await N.delete(`${E}/procurements/${n}`)).data},async list(n){return(await N.get(`${E}/procurements`,{params:n})).data},async complete(n){return(await N.put(`${E}/procurements/${n}/complete`)).data}},De=me("procurement",()=>{const n=y({total:0,totalPages:1,currentPage:1,pageSize:10,data:[]}),f=y(null),c=y(!1),p=y(null),_=y(!1);return{items:n,item:f,isLoading:c,error:p,isLoaded:_,fetchItems:async(m={},v=!1)=>{var o;if(p.value=null,!(!v&&_.value))try{c.value=!0;const r=await F.list(m);Object.assign(n.value,{total:r.total||0,totalPages:r.totalPages||1,currentPage:m.page||1,pageSize:m.limit||10,data:r.data||[]}),_.value=!0}catch(r){p.value=((o=r==null?void 0:r.response)==null?void 0:o.message)||"Failed to fetch procurements"}finally{c.value=!1}},fetchItemById:async m=>{var v;p.value=null;try{c.value=!0;const o=await F.getById(m);f.value=o}catch(o){p.value=((v=o==null?void 0:o.response)==null?void 0:v.message)||"Failed to fetch procurement"}finally{c.value=!1}},createItem:async m=>{var v;p.value=null;try{c.value=!0;const o=await F.create(m);n.value.data.push(o),n.value.total+=1}catch(o){p.value=((v=o==null?void 0:o.response)==null?void 0:v.message)||"Failed to create procurement"}finally{c.value=!1}},updateItem:async(m,v)=>{var o;p.value=null;try{c.value=!0;const r=await F.updateById(m,v),B=n.value.data.findIndex(z=>z.id===m);B!==-1&&(n.value.data[B]=r)}catch(r){p.value=((o=r==null?void 0:r.response)==null?void 0:o.message)||"Failed to update procurement"}finally{c.value=!1}},deleteItem:async m=>{var v;p.value=null;try{c.value=!0,await F.delete(m),n.value.data=n.value.data.filter(o=>o.id!==m),n.value.total-=1}catch(o){p.value=((v=o==null?void 0:o.response)==null?void 0:v.message)||"Failed to delete procurement"}finally{c.value=!1}},completeItem:async m=>{var v;p.value=null;try{c.value=!0;const o=await F.complete(m),r=n.value.data.findIndex(B=>B.id===m);r!==-1&&(n.value.data[r]=o)}catch(o){p.value=((v=o==null?void 0:o.response)==null?void 0:v.message)||"Failed to complete procurement"}finally{c.value=!1}},resetStore:()=>{n.value={total:0,totalPages:1,currentPage:1,pageSize:10,data:[]},f.value=null,_.value=!1,c.value=!1,p.value=null}}}),Ve={class:"flex items-center gap-2"},Ne={class:"flex gap-2"},Ue={key:0,class:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"},qe={class:"bg-white p-6 rounded shadow-lg w-[600px] relative"},Ee=e("h2",{class:"text-xl mb-4"},"Add Procurement",-1),Fe={class:"mb-4"},Le=e("label",{class:"block mb-1"},"Supplier",-1),Me=e("option",{value:""},"Select Supplier",-1),Oe=["value"],ze={class:"mb-4"},Te=e("label",{class:"block mb-1"},"Warehouse",-1),je=e("option",{value:""},"Select Warehouse",-1),Qe=["value"],We={class:"mb-4 relative"},Je=e("label",{class:"block mb-1"},"Items",-1),Ke={class:"flex gap-2 mb-2"},Re={key:0,class:"absolute z-50 border p-2 mt-1 rounded bg-white max-h-48 overflow-y-auto w-full"},Ye=["onClick"],Ge={class:"w-full border mt-2"},He=e("thead",{class:"bg-gray-200"},[e("tr",null,[e("th",{class:"p-2"},"Item Name"),e("th",{class:"p-2"},"Quantity"),e("th",{class:"p-2"},"Purchase Cost"),e("th",{class:"p-2"},"Amount"),e("th",{class:"p-2"},"Action")])],-1),Xe={class:"p-2"},Ze={class:"p-2 w-24"},et=["onUpdate:modelValue"],tt={class:"p-2 w-24"},st={class:"p-2 w-24"},at={class:"p-2 w-16 text-center"},ot=["onClick"],lt={key:1,class:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"},nt={class:"bg-white p-6 rounded shadow-lg w-[600px] relative"},rt=e("h2",{class:"text-xl mb-4"},"Edit Procurement",-1),it={class:"mb-4"},ut=e("label",{class:"block mb-1"},"Supplier",-1),ct=e("option",{value:""},"Select Supplier",-1),dt=["value"],mt={class:"mb-4"},pt=e("label",{class:"block mb-1"},"Warehouse",-1),_t=e("option",{value:""},"Select Warehouse",-1),vt=["value"],ht={class:"mb-4"},ft=e("label",{class:"block mb-1"},"Procurement Date",-1),bt={class:"mb-4 relative"},yt=e("label",{class:"block mb-1"},"Items",-1),gt={class:"flex gap-2 mb-2"},wt={key:0,class:"absolute z-50 border p-2 mt-1 rounded bg-white max-h-48 overflow-y-auto w-full"},xt=["onClick"],kt={class:"w-full border mt-2"},St=e("thead",{class:"bg-gray-200"},[e("tr",null,[e("th",{class:"p-2"},"Item Name"),e("th",{class:"p-2"},"Quantity"),e("th",{class:"p-2"},"Purchase Cost"),e("th",{class:"p-2"},"Amount"),e("th",{class:"p-2"},"Action")])],-1),It={class:"p-2"},Ct={class:"p-2 w-24"},Pt=["onUpdate:modelValue"],$t={class:"p-2 w-24"},At={class:"p-2 w-24"},Bt={class:"p-2 w-16 text-center"},Dt=["onClick"],Vt={key:2,class:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"},Nt={class:"bg-white p-4 rounded shadow-lg w-[400px]"},Ut=e("h2",{class:"text-lg font-bold mb-2"},"Procurement Details",-1),qt={class:"mb-2 text-sm"},Et=e("strong",null,"Supplier:",-1),Ft={class:"mb-2 text-sm"},Lt=e("strong",null,"Warehouse:",-1),Mt={class:"mb-2 text-sm"},Ot=e("strong",null,"Date:",-1),zt={class:"mb-2 text-sm"},Tt=e("strong",null,"Status:",-1),jt={class:"mb-2 text-sm"},Qt=e("strong",null,"Items:",-1),Wt={class:"w-full mt-1 text-xs border"},Jt=e("thead",null,[e("tr",{class:"bg-gray-200"},[e("th",{class:"p-1 border"},"Item"),e("th",{class:"p-1 border"},"Qty"),e("th",{class:"p-1 border"},"Cost"),e("th",{class:"p-1 border"},"Amt")])],-1),Kt={class:"p-1 border"},Rt={class:"p-1 border"},Yt={class:"p-1 border"},Gt={class:"p-1 border"},ys={__name:"ProcurementView",setup(n){const f=y(!1),c=y(!1),p=y(!1),_=y({supplier_id:"",items:[],warehouse_id:"",procurement_date:new Date().toISOString().slice(0,10),status:"pending"}),g=y(""),h=y({id:null,supplier_id:"",items:[],warehouse_id:"",procurement_date:"",status:""}),x=y(""),k=y({}),V=y([]),d=De(),j=$e(),m=Ae(),v=Be(),o=pe();async function r(s={},a=!1){await d.fetchItems(s,a)}r({page:1,limit:10}),_e(async()=>{await j.fetchItems({page:1,limit:100},!0),await m.fetchAll({page:1,limit:100},!0),await v.fetchItems({page:1,limit:100},!0)});const B=U(()=>{var s,a,t,b,$;return{total:((s=d.items)==null?void 0:s.total)||0,totalPages:((a=d.items)==null?void 0:a.totalPages)||1,currentPage:((t=d.items)==null?void 0:t.currentPage)||1,pageSize:((b=d.items)==null?void 0:b.pageSize)||10,data:(($=d.items)==null?void 0:$.data)||[]}}),z=U(()=>j.items.data),K=U(()=>m.warehouses),R=U(()=>v.items.data),Q=U(()=>g.value?R.value.filter(s=>s.name.toLowerCase().includes(g.value.toLowerCase())):[]),W=U(()=>x.value?R.value.filter(s=>s.name.toLowerCase().includes(x.value.toLowerCase())):[]),Y=[{key:"supplier",label:"Supplier",formatter:(s,a)=>a.supplier?a.supplier.name:""},{key:"warehouse",label:"Warehouse",formatter:(s,a)=>a.warehouse?a.warehouse.name:""},{key:"procurement_date",label:"Date",sortable:!0,filterable:!0,formatter:(s,a)=>a.procurement_date?new Date(a.procurement_date).toLocaleString():""},{key:"status",label:"Status",sortable:!0,filterable:!0}],G=async s=>{await r(s,!0)},H=s=>{V.value=s},X=s=>{h.value={id:s.id,supplier_id:s.supplier_id,warehouse_id:s.warehouse_id,procurement_date:s.procurement_date?new Date(s.procurement_date).toISOString().slice(0,16):"",status:s.status,items:s.items?s.items:[]},c.value=!0};async function Z(){await d.updateItem(h.value.id,h.value),d.error||(c.value=!1,await r({page:1,limit:10},!0))}function ee(){c.value=!1}const te=()=>{_.value={supplier_id:"",items:[],warehouse_id:"",procurement_date:new Date().toISOString().slice(0,10),status:"pending"},g.value="",f.value=!0};async function se(){_.value.items.forEach((a,t)=>{a.item_id||console.error(`Item at index ${t} is missing item_id:`,a)});const s={..._.value,user_id:o.user?o.user.id:null};await d.createItem(s),d.error||(f.value=!1,await r({page:1,limit:10},!0))}function ae(){if(!g.value)return;const s=Q.value[0];if(s&&!_.value.items.find(t=>t.item_id===s.id)){const t={item_id:s.id,name:s.name,quantity:1,purchase_cost:0};console.log("Adding item:",t),_.value.items.push(t)}g.value=""}function oe(s){_.value.items.splice(s,1)}function le(){if(!x.value)return;const s=W.value[0];if(s&&!h.value.items.find(t=>t.item_id===s.id)){const t={item_id:s.id,name:s.name,quantity:1,purchase_cost:0};h.value.items.push(t)}x.value=""}function ne(s){h.value.items.splice(s,1)}async function re(){if(V.value.length===0)return;if((await J.fire({title:"Are you sure?",text:"This action cannot be undone!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete them!"})).isConfirmed){for(const a of V.value)if(await d.deleteItem(a),d.error)break;d.error||(V.value=[],await r({page:1,limit:10},!0),J.fire("Deleted!","The procurements have been deleted.","success"))}}async function ie(s){await d.completeItem(s.id),d.error||(await r({page:1,limit:10},!0),J.fire("Approved!","The procurement has been approved.","success"))}function ue(s){k.value=s,p.value=!0}function ce(){p.value=!1}function de(){f.value=!1}return(s,a)=>(l(),L(ve,null,{default:q(()=>[A(he,null,{default:q(()=>[w(d).error?(l(),L(fe,{key:0,icon:w(we),color:"danger"},{default:q(()=>[M(u(w(d).error),1)]),_:1},8,["icon"])):S("",!0),A(ge,{icon:w(xe),title:"Procurements",main:""},{default:q(()=>[e("div",Ve,[A(D,{icon:w(ke),color:"primary",label:"New Procurement",onClick:te},null,8,["icon"]),V.value.length?(l(),L(D,{key:0,icon:w(Se),color:"danger",label:"Delete",onClick:re},null,8,["icon"])):S("",!0)])]),_:1},8,["icon"]),A(ye,{class:"mb-6"},{default:q(()=>[A(be,{columns:Y,data:B.value,total:B.value.total,loading:w(d).isLoading,checkable:"",onQueryChange:G,onSelected:H},{"cell-actions":q(({row:t})=>[e("div",Ne,[A(D,{icon:w(Ie),color:"primary",onClick:b=>ue(t)},null,8,["icon","onClick"]),t.status!=="received"?(l(),L(D,{key:0,icon:w(Ce),color:"primary",onClick:b=>X(t)},null,8,["icon","onClick"])):S("",!0),t.status!=="received"?(l(),L(D,{key:1,icon:w(Pe),color:"primary",onClick:b=>ie(t)},null,8,["icon","onClick"])):S("",!0)])]),_:1},8,["data","total","loading"])]),_:1})]),_:1}),f.value?(l(),i("div",Ue,[e("div",qe,[Ee,e("div",Fe,[Le,I(e("select",{"onUpdate:modelValue":a[0]||(a[0]=t=>_.value.supplier_id=t),class:"w-full border p-2 rounded"},[Me,(l(!0),i(C,null,P(z.value,t=>(l(),i("option",{key:t.id,value:t.id},u(t.name),9,Oe))),128))],512),[[T,_.value.supplier_id]])]),e("div",ze,[Te,I(e("select",{"onUpdate:modelValue":a[1]||(a[1]=t=>_.value.warehouse_id=t),class:"w-full border p-2 rounded"},[je,(l(!0),i(C,null,P(K.value,t=>(l(),i("option",{key:t.id,value:t.id},u(t.name),9,Qe))),128))],512),[[T,_.value.warehouse_id]])]),e("div",We,[Je,e("div",Ke,[I(e("input",{"onUpdate:modelValue":a[2]||(a[2]=t=>g.value=t),type:"text",placeholder:"Search item by name",class:"w-full border p-2 rounded"},null,512),[[O,g.value]]),A(D,{label:"Add",color:"primary",onClick:ae})]),g.value&&Q.value.length?(l(),i("div",Re,[e("ul",null,[(l(!0),i(C,null,P(Q.value,t=>(l(),i("li",{key:t.id,class:"cursor-pointer hover:bg-gray-100 p-1",onClick:()=>{_.value.items.find(b=>b.item_id===t.id)||_.value.items.push({item_id:t.id,name:t.name,quantity:1,purchase_cost:t.cost}),g.value=""}},u(t.name),9,Ye))),128))])])):S("",!0),e("table",Ge,[He,e("tbody",null,[(l(!0),i(C,null,P(_.value.items,(t,b)=>(l(),i("tr",{key:t.item_id,class:"border-b"},[e("td",Xe,u(t.name),1),e("td",Ze,[I(e("input",{type:"number",min:"1",class:"border p-1 w-full","onUpdate:modelValue":$=>t.quantity=$},null,8,et),[[O,t.quantity,void 0,{number:!0}]])]),e("td",tt,u(t.purchase_cost),1),e("td",st,u((t.quantity||0)*(t.purchase_cost||0)),1),e("td",at,[e("button",{class:"text-red-500",onClick:$=>oe(b)},"×",8,ot)])]))),128))])])]),e("div",{class:"flex justify-end space-x-2 mt-4"},[e("button",{class:"px-4 py-2 bg-gray-200 rounded",onClick:de}," Cancel "),e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded",onClick:se}," Save ")])])])):S("",!0),c.value?(l(),i("div",lt,[e("div",nt,[rt,e("div",it,[ut,I(e("select",{"onUpdate:modelValue":a[3]||(a[3]=t=>h.value.supplier_id=t),class:"w-full border p-2 rounded"},[ct,(l(!0),i(C,null,P(z.value,t=>(l(),i("option",{key:t.id,value:t.id},u(t.name),9,dt))),128))],512),[[T,h.value.supplier_id]])]),e("div",mt,[pt,I(e("select",{"onUpdate:modelValue":a[4]||(a[4]=t=>h.value.warehouse_id=t),class:"w-full border p-2 rounded"},[_t,(l(!0),i(C,null,P(K.value,t=>(l(),i("option",{key:t.id,value:t.id},u(t.name),9,vt))),128))],512),[[T,h.value.warehouse_id]])]),e("div",ht,[ft,I(e("input",{"onUpdate:modelValue":a[5]||(a[5]=t=>h.value.procurement_date=t),type:"datetime-local",class:"w-full border p-2 rounded"},null,512),[[O,h.value.procurement_date]])]),e("div",bt,[yt,e("div",gt,[I(e("input",{"onUpdate:modelValue":a[6]||(a[6]=t=>x.value=t),type:"text",placeholder:"Search item by name",class:"w-full border p-2 rounded"},null,512),[[O,x.value]]),A(D,{label:"Add",color:"primary",onClick:le})]),x.value&&W.value.length?(l(),i("div",wt,[e("ul",null,[(l(!0),i(C,null,P(W.value,t=>(l(),i("li",{key:t.id,class:"cursor-pointer hover:bg-gray-100 p-1",onClick:()=>{h.value.items.find(b=>b.item_id===t.id)||h.value.items.push({item_id:t.id,name:t.name,quantity:1,purchase_cost:0}),x.value=""}},u(t.name),9,xt))),128))])])):S("",!0),e("table",kt,[St,e("tbody",null,[(l(!0),i(C,null,P(h.value.items,(t,b)=>(l(),i("tr",{key:t.item_id,class:"border-b"},[e("td",It,u(t.item.name),1),e("td",Ct,[I(e("input",{type:"number",min:"1",class:"border p-1 w-full","onUpdate:modelValue":$=>t.quantity=$},null,8,Pt),[[O,t.quantity,void 0,{number:!0}]])]),e("td",$t,u(t.item.cost),1),e("td",At,u((t.quantity||0)*(t.item.cost||0)),1),e("td",Bt,[e("button",{class:"text-red-500",onClick:$=>ne(b)},"×",8,Dt)])]))),128))])])]),e("div",{class:"flex justify-end space-x-2 mt-4"},[e("button",{class:"px-4 py-2 bg-gray-200 rounded",onClick:ee}," Cancel "),e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded",onClick:Z}," Save Changes ")])])])):S("",!0),p.value?(l(),i("div",Vt,[e("div",Nt,[Ut,e("div",qt,[Et,M(" "+u(k.value.supplier?k.value.supplier.name:"N/A"),1)]),e("div",Ft,[Lt,M(" "+u(k.value.warehouse?k.value.warehouse.name:"N/A"),1)]),e("div",Mt,[Ot,M(" "+u(k.value.procurement_date),1)]),e("div",zt,[Tt,M(" "+u(k.value.status),1)]),e("div",jt,[Qt,e("table",Wt,[Jt,e("tbody",null,[(l(!0),i(C,null,P(k.value.items,(t,b)=>(l(),i("tr",{key:b,class:"border-b"},[e("td",Kt,u(t.item.name),1),e("td",Rt,u(t.quantity),1),e("td",Yt,u(t.cost),1),e("td",Gt,u((t.quantity||0)*(t.cost||0)),1)]))),128))])])]),e("div",{class:"flex justify-end mt-2"},[e("button",{class:"px-3 py-1 bg-blue-600 text-white rounded text-xs",onClick:ce}," Close ")])])])):S("",!0)]),_:1}))}};export{ys as default};
