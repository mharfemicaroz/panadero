import{J as U,K as ce,a as g,u as ue,q as me,s as M,b as n,c as T,e as q,f as $,h as k,v as z,t as i,m as S,i as e,l as _,B as O,L as K,F as N,x as P,C as V,S as J}from"./index.81ed66ed.js";import{_ as pe}from"./LayoutAuthenticatedX.a0217d4b.js";import{_ as _e}from"./SectionMain.ff7c0a76.js";import{_ as ve}from"./NotificationBar.62c87214.js";import{B as fe}from"./BaseTable.aa93a529.js";import{_ as he}from"./CardBox.d4dece43.js";import{_ as be}from"./SectionTitleLineWithButton.9b4305a6.js";import{_ as B}from"./BaseButton.4cf3599a.js";import{p as ye,c as ge,u as we,v as xe,h as ke,y as Ie,z as Ce}from"./mdi.aa269c9f.js";import{A as E}from"./index.8f8d0999.js";import{u as Se}from"./customer.5d68ee00.js";import{u as Oe}from"./item.e99833f6.js";import"./darkMode.4d354904.js";import"./BaseIcon.f7bbc3f6.js";import"./FormControl.7fdae42f.js";import"./FooterBar.223d3b14.js";import"./logo.c6f18b48.js";import"./BaseLevel.f8579f88.js";import"./TableCheckboxCell.5bd18b8c.js";import"./BaseButtons.e89c9a47.js";import"./_plugin-vue_export-helper.c27b6911.js";const F={async list(l){return(await U.get(`${E}/orders`,{params:l})).data},async create(l){return(await U.post(`${E}/orders`,l)).data},async getById(l){return(await U.get(`${E}/orders/${l}`)).data},async updateById(l,h){return(await U.put(`${E}/orders/${l}`,h)).data},async delete(l){return(await U.delete(`${E}/orders/${l}`)).data},async complete(l){return(await U.put(`${E}/orders/${l}/complete`)).data}},$e=ce("order",()=>{const l=g({total:0,totalPages:1,currentPage:1,pageSize:10,data:[]}),h=g(null),d=g(!1),v=g(null),c=g(!1);return{items:l,item:h,isLoading:d,error:v,isLoaded:c,fetchItems:async(m={},f=!1)=>{var r,a;if(v.value=null,!(!f&&c.value))try{d.value=!0;const p=await F.list(m);Object.assign(l.value,{total:p.total||0,totalPages:p.totalPages||1,currentPage:m.page||1,pageSize:m.limit||10,data:p.data||[]}),c.value=!0}catch(p){v.value=((a=(r=p==null?void 0:p.response)==null?void 0:r.data)==null?void 0:a.message)||"Failed to fetch orders"}finally{d.value=!1}},fetchItemById:async m=>{var f,r;v.value=null;try{d.value=!0;const a=await F.getById(m);h.value=a}catch(a){v.value=((r=(f=a==null?void 0:a.response)==null?void 0:f.data)==null?void 0:r.message)||"Failed to fetch order"}finally{d.value=!1}},createItem:async m=>{var f,r;v.value=null;try{d.value=!0;const a=await F.create(m);l.value.data.push(a),l.value.total+=1}catch(a){v.value=((r=(f=a==null?void 0:a.response)==null?void 0:f.data)==null?void 0:r.message)||"Failed to create order"}finally{d.value=!1}},updateItem:async(m,f)=>{var r,a;v.value=null;try{d.value=!0;const p=await F.updateById(m,f),D=l.value.data.findIndex(L=>L.id===m);D!==-1&&(l.value.data[D]=p)}catch(p){v.value=((a=(r=p==null?void 0:p.response)==null?void 0:r.data)==null?void 0:a.message)||"Failed to update order"}finally{d.value=!1}},deleteItem:async m=>{var f,r;v.value=null;try{d.value=!0,await F.delete(m),l.value.data=l.value.data.filter(a=>a.id!==m),l.value.total-=1}catch(a){v.value=((r=(f=a==null?void 0:a.response)==null?void 0:f.data)==null?void 0:r.message)||"Failed to delete order"}finally{d.value=!1}},completeItem:async m=>{var f,r;v.value=null;try{d.value=!0;const a=await F.complete(m),p=l.value.data.findIndex(D=>D.id===m);p!==-1&&(l.value.data[p]=a)}catch(a){v.value=((r=(f=a==null?void 0:a.response)==null?void 0:f.data)==null?void 0:r.message)||"Failed to complete order"}finally{d.value=!1}},resetStore:()=>{l.value={total:0,totalPages:1,currentPage:1,pageSize:10,data:[]},h.value=null,c.value=!1,d.value=!1,v.value=null}}}),De={class:"flex items-center gap-2"},Ne={class:"flex gap-2"},Pe={key:0,class:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"},Ve={class:"bg-white p-6 rounded shadow-lg w-[600px] relative"},Be=e("h2",{class:"text-xl mb-4"},"New Purchase Order",-1),Ae={class:"mb-4"},Ue=e("label",{class:"block mb-1"},"Customer",-1),qe=e("option",{value:""},"Select Customer",-1),Ee=["value"],Fe={class:"mb-4 relative"},Le=e("label",{class:"block mb-1"},"Order Items",-1),Me={class:"flex gap-2 mb-2"},Te={key:0,class:"absolute z-50 border p-2 mt-1 rounded bg-white max-h-48 overflow-y-auto w-full"},ze=["onClick"],je={class:"w-full border mt-2"},Qe=e("thead",{class:"bg-gray-200"},[e("tr",null,[e("th",{class:"p-2"},"Item Name"),e("th",{class:"p-2"},"Quantity"),e("th",{class:"p-2"},"Price"),e("th",{class:"p-2"},"Discount"),e("th",{class:"p-2"},"Amount"),e("th",{class:"p-2"},"Action")])],-1),Je={class:"p-2"},Ke={class:"p-2 w-16"},Re=["onUpdate:modelValue"],Ye={class:"p-2 w-20"},Ge={class:"p-2 w-20"},He=["onUpdate:modelValue"],We={class:"p-2 w-24"},Xe={class:"p-2 w-16 text-center"},Ze=["onClick"],et={key:1,class:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"},tt={class:"bg-white p-6 rounded shadow-lg w-[600px] relative"},st=e("h2",{class:"text-xl mb-4"},"Edit Purchase Order",-1),at={class:"mb-4"},ot=e("label",{class:"block mb-1"},"Customer",-1),lt=e("option",{value:""},"Select Customer",-1),rt=["value"],nt={class:"mb-4"},it=e("label",{class:"block mb-1"},"Order Date",-1),dt={class:"mb-4 relative"},ct=e("label",{class:"block mb-1"},"Order Items",-1),ut={class:"flex gap-2 mb-2"},mt={key:0,class:"absolute z-50 border p-2 mt-1 rounded bg-white max-h-48 overflow-y-auto w-full"},pt=["onClick"],_t={class:"w-full border mt-2"},vt=e("thead",{class:"bg-gray-200"},[e("tr",null,[e("th",{class:"p-2"},"Item Name"),e("th",{class:"p-2"},"Quantity"),e("th",{class:"p-2"},"Price"),e("th",{class:"p-2"},"Discount"),e("th",{class:"p-2"},"Amount"),e("th",{class:"p-2"},"Action")])],-1),ft={class:"p-2"},ht={class:"p-2 w-16"},bt=["onUpdate:modelValue"],yt={class:"p-2 w-20"},gt={class:"p-2 w-20"},wt=["onUpdate:modelValue"],xt={class:"p-2 w-24"},kt={class:"p-2 w-16 text-center"},It=["onClick"],Ct={key:2,class:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"},St={class:"bg-white p-4 rounded shadow-lg w-[400px]"},Ot=e("h2",{class:"text-lg font-bold mb-2"},"Order Details",-1),$t={class:"mb-2 text-sm"},Dt=e("strong",null,"Customer:",-1),Nt={class:"mb-2 text-sm"},Pt=e("strong",null,"Date:",-1),Vt={class:"mb-2 text-sm"},Bt=e("strong",null,"Status:",-1),At={class:"mb-2 text-sm"},Ut=e("strong",null,"Total Amount:",-1),qt={class:"mb-2 text-sm"},Et=e("strong",null,"Items:",-1),Ft={class:"w-full mt-1 text-xs border"},Lt=e("thead",null,[e("tr",{class:"bg-gray-200"},[e("th",{class:"p-1 border"},"Item"),e("th",{class:"p-1 border"},"Qty"),e("th",{class:"p-1 border"},"Price"),e("th",{class:"p-1 border"},"Discount"),e("th",{class:"p-1 border"},"Amt")])],-1),Mt={class:"p-1 border"},Tt={class:"p-1 border"},zt={class:"p-1 border"},jt={class:"p-1 border"},Qt={class:"p-1 border"},ms={__name:"PurchaseOrder",setup(l){const h=g(!1),d=g(!1),v=g(!1),c=g({user_id:null,customer_id:"",items:[],order_date:new Date().toISOString().slice(0,10),status:"pending",total_amount:0}),x=g(""),y=g({id:null,customer_id:"",items:[],order_date:""}),I=g(""),C=g({}),A=g([]),u=$e(),j=Se(),m=Oe(),f=ue();async function r(s={},o=!1){await u.fetchItems(s,o)}r({page:1,limit:10}),me(async()=>{await j.fetchItems({page:1,limit:100},!0),await m.fetchItems({page:1,limit:100},!0)});const a=M(()=>{var s,o,t,b,w;return{total:((s=u.items)==null?void 0:s.total)||0,totalPages:((o=u.items)==null?void 0:o.totalPages)||1,currentPage:((t=u.items)==null?void 0:t.currentPage)||1,pageSize:((b=u.items)==null?void 0:b.pageSize)||10,data:((w=u.items)==null?void 0:w.data)||[]}}),p=M(()=>j.items.data),D=M(()=>m.items.data),L=M(()=>x.value?D.value.filter(s=>s.name.toLowerCase().includes(x.value.toLowerCase())):[]),Q=M(()=>I.value?D.value.filter(s=>s.name.toLowerCase().includes(I.value.toLowerCase())):[]),R=[{key:"customer",label:"Customer",formatter:(s,o)=>o.customer?o.customer.first_name+" "+o.customer.last_name:""},{key:"order_date",label:"Date",sortable:!0,filterable:!0,formatter:(s,o)=>o.order_date?new Date(o.order_date).toLocaleString():""},{key:"status",label:"Status",sortable:!0,filterable:!0},{key:"total_amount",label:"Total",sortable:!0,filterable:!0}],Y=async s=>{await r(s,!0)},G=s=>{A.value=s},H=s=>{y.value={id:s.id,customer_id:s.customer_id,order_date:s.order_date?new Date(s.order_date).toISOString().slice(0,16):"",items:s.orderItems?JSON.parse(JSON.stringify(s.orderItems)):[]},d.value=!0};async function W(){await u.updateItem(y.value.id,y.value),u.error||(d.value=!1,await r({page:1,limit:10},!0))}function X(){d.value=!1}const Z=()=>{c.value={user_id:f.user?f.user.id:null,customer_id:"",items:[],order_date:new Date().toISOString().slice(0,10),status:"pending",total_amount:0},x.value="",h.value=!0};async function ee(){c.value.total_amount=c.value.items.reduce((s,o)=>s+o.quantity*((o.price||0)-(o.discount||0)),0),console.log("Saving order with payload:",JSON.stringify(c.value,null,2)),c.value.items.forEach((s,o)=>{s.item_id||console.error(`Item at index ${o} is missing item_id:`,s)}),await u.createItem(c.value),u.error||(h.value=!1,await r({page:1,limit:10},!0))}function te(){if(!x.value)return;const s=L.value[0];if(s&&!c.value.items.find(t=>t.item_id===s.id)){const t={item_id:s.id,name:s.name,quantity:1,price:s.price,discount:0};console.log("Adding item:",t),c.value.items.push(t)}x.value=""}function se(s){c.value.items.splice(s,1)}function ae(){if(!I.value)return;const s=Q.value[0];if(s&&!y.value.items.find(t=>t.item_id===s.id)){const t={item_id:s.id,name:s.name,quantity:1,price:s.price,discount:0};y.value.items.push(t)}I.value=""}function oe(s){y.value.items.splice(s,1)}async function le(){if(A.value.length===0)return;if((await J.fire({title:"Are you sure?",text:"This action cannot be undone!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete them!"})).isConfirmed){for(const o of A.value)if(await u.deleteItem(o),u.error)break;u.error||(A.value=[],await r({page:1,limit:10},!0),J.fire("Deleted!","The orders have been deleted.","success"))}}async function re(s){await u.completeItem(s.id),u.error||(await r({page:1,limit:10},!0),J.fire("Completed!","The order has been completed.","success"))}function ne(s){C.value=s,v.value=!0}function ie(){v.value=!1}function de(){h.value=!1}return(s,o)=>(n(),T(pe,null,{default:q(()=>[$(_e,null,{default:q(()=>[k(u).error?(n(),T(ve,{key:0,icon:k(ye),color:"danger"},{default:q(()=>[z(i(k(u).error),1)]),_:1},8,["icon"])):S("",!0),$(be,{icon:k(ge),title:"Purchase Orders",main:""},{default:q(()=>[e("div",De,[$(B,{icon:k(we),color:"primary",label:"New Order",onClick:Z},null,8,["icon"]),A.value.length?(n(),T(B,{key:0,icon:k(xe),color:"danger",label:"Delete",onClick:le},null,8,["icon"])):S("",!0)])]),_:1},8,["icon"]),$(he,{class:"mb-6"},{default:q(()=>[$(fe,{columns:R,data:a.value,total:a.value.total,loading:k(u).isLoading,checkable:"",onQueryChange:Y,onSelected:G},{"cell-actions":q(({row:t})=>[e("div",Ne,[$(B,{icon:k(ke),color:"primary",onClick:b=>ne(t)},null,8,["icon","onClick"]),t.status!=="completed"?(n(),T(B,{key:0,icon:k(Ie),color:"primary",onClick:b=>H(t)},null,8,["icon","onClick"])):S("",!0),t.status!=="completed"?(n(),T(B,{key:1,icon:k(Ce),color:"primary",onClick:b=>re(t)},null,8,["icon","onClick"])):S("",!0)])]),_:1},8,["data","total","loading"])]),_:1})]),_:1}),h.value?(n(),_("div",Pe,[e("div",Ve,[Be,e("div",Ae,[Ue,O(e("select",{"onUpdate:modelValue":o[0]||(o[0]=t=>c.value.customer_id=t),class:"w-full border p-2 rounded"},[qe,(n(!0),_(N,null,P(p.value,t=>(n(),_("option",{key:t.id,value:t.id},i(t.first_name)+" "+i(t.last_name),9,Ee))),128))],512),[[K,c.value.customer_id]])]),e("div",Fe,[Le,e("div",Me,[O(e("input",{"onUpdate:modelValue":o[1]||(o[1]=t=>x.value=t),type:"text",placeholder:"Search item by name",class:"w-full border p-2 rounded"},null,512),[[V,x.value]]),$(B,{label:"Add",color:"primary",onClick:te})]),x.value&&L.value.length?(n(),_("div",Te,[e("ul",null,[(n(!0),_(N,null,P(L.value,t=>(n(),_("li",{key:t.id,class:"cursor-pointer hover:bg-gray-100 p-1",onClick:()=>{c.value.items.find(b=>b.item_id===t.id)||c.value.items.push({item_id:t.id,name:t.name,quantity:1,price:t.price,discount:0}),x.value=""}},i(t.name),9,ze))),128))])])):S("",!0),e("table",je,[Qe,e("tbody",null,[(n(!0),_(N,null,P(c.value.items,(t,b)=>(n(),_("tr",{key:t.item_id,class:"border-b"},[e("td",Je,i(t.name),1),e("td",Ke,[O(e("input",{type:"number",min:"1",class:"border p-1 w-full","onUpdate:modelValue":w=>t.quantity=w},null,8,Re),[[V,t.quantity,void 0,{number:!0}]])]),e("td",Ye,i(t.price),1),e("td",Ge,[O(e("input",{type:"number",min:"0",step:"0.01",class:"border p-1 w-full","onUpdate:modelValue":w=>t.discount=w},null,8,He),[[V,t.discount,void 0,{number:!0}]])]),e("td",We,i((t.quantity||0)*((t.price||0)-(t.discount||0))),1),e("td",Xe,[e("button",{class:"text-red-500",onClick:w=>se(b)},"×",8,Ze)])]))),128))])])]),e("div",{class:"flex justify-end space-x-2 mt-4"},[e("button",{class:"px-4 py-2 bg-gray-200 rounded",onClick:de},"Cancel"),e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded",onClick:ee}," Save ")])])])):S("",!0),d.value?(n(),_("div",et,[e("div",tt,[st,e("div",at,[ot,O(e("select",{"onUpdate:modelValue":o[2]||(o[2]=t=>y.value.customer_id=t),class:"w-full border p-2 rounded"},[lt,(n(!0),_(N,null,P(p.value,t=>(n(),_("option",{key:t.id,value:t.id},i(t.first_name)+" "+i(t.last_name),9,rt))),128))],512),[[K,y.value.customer_id]])]),e("div",nt,[it,O(e("input",{"onUpdate:modelValue":o[3]||(o[3]=t=>y.value.order_date=t),type:"datetime-local",class:"w-full border p-2 rounded"},null,512),[[V,y.value.order_date]])]),e("div",dt,[ct,e("div",ut,[O(e("input",{"onUpdate:modelValue":o[4]||(o[4]=t=>I.value=t),type:"text",placeholder:"Search item by name",class:"w-full border p-2 rounded"},null,512),[[V,I.value]]),$(B,{label:"Add",color:"primary",onClick:ae})]),I.value&&Q.value.length?(n(),_("div",mt,[e("ul",null,[(n(!0),_(N,null,P(Q.value,t=>(n(),_("li",{key:t.id,class:"cursor-pointer hover:bg-gray-100 p-1",onClick:()=>{y.value.items.find(b=>b.item_id===t.id)||y.value.items.push({item_id:t.id,name:t.name,quantity:1,price:t.price,discount:0}),I.value=""}},i(t.name),9,pt))),128))])])):S("",!0),e("table",_t,[vt,e("tbody",null,[(n(!0),_(N,null,P(y.value.items,(t,b)=>(n(),_("tr",{key:t.item_id,class:"border-b"},[e("td",ft,i(t.item.name),1),e("td",ht,[O(e("input",{type:"number",min:"1",class:"border p-1 w-full","onUpdate:modelValue":w=>t.quantity=w},null,8,bt),[[V,t.quantity,void 0,{number:!0}]])]),e("td",yt,i(t.price),1),e("td",gt,[O(e("input",{type:"number",min:"0",step:"0.01",class:"border p-1 w-full","onUpdate:modelValue":w=>t.discount=w},null,8,wt),[[V,t.discount,void 0,{number:!0}]])]),e("td",xt,i((t.quantity||0)*((t.price||0)-(t.discount||0))),1),e("td",kt,[e("button",{class:"text-red-500",onClick:w=>oe(b)},"×",8,It)])]))),128))])])]),e("div",{class:"flex justify-end space-x-2 mt-4"},[e("button",{class:"px-4 py-2 bg-gray-200 rounded",onClick:X},"Cancel"),e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded",onClick:W}," Save Changes ")])])])):S("",!0),v.value?(n(),_("div",Ct,[e("div",St,[Ot,e("div",$t,[Dt,z(" "+i(C.value.customer?C.value.customer.first_name+" "+C.value.customer.last_name:"N/A"),1)]),e("div",Nt,[Pt,z(" "+i(C.value.order_date),1)]),e("div",Vt,[Bt,z(" "+i(C.value.status),1)]),e("div",At,[Ut,z(" "+i(C.value.total_amount),1)]),e("div",qt,[Et,e("table",Ft,[Lt,e("tbody",null,[(n(!0),_(N,null,P(C.value.orderItems,(t,b)=>(n(),_("tr",{key:b,class:"border-b"},[e("td",Mt,i(t.item.name),1),e("td",Tt,i(t.quantity),1),e("td",zt,i(t.price),1),e("td",jt,i(t.discount),1),e("td",Qt,i((t.quantity||0)*((t.price||0)-(t.discount||0))),1)]))),128))])])]),e("div",{class:"flex justify-end mt-2"},[e("button",{class:"px-3 py-1 bg-blue-600 text-white rounded text-xs",onClick:ie}," Close ")])])])):S("",!0)]),_:1}))}};export{ms as default};
