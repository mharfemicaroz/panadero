import{J as N,K as de,a as y,q as me,s as U,b as l,c as L,e as q,f as B,h as w,v as M,t as i,m as S,i as e,l as r,B as I,L as T,F as C,x as P,C as O,S as J}from"./index.a2c9f28c.js";import{_ as pe}from"./LayoutAuthenticatedX.d58fd7d8.js";import{_ as _e}from"./SectionMain.8435c1f0.js";import{_ as ve}from"./NotificationBar.caa84e93.js";import{B as he}from"./BaseTable.a063d648.js";import{_ as fe}from"./CardBox.25a3dc7a.js";import{_ as be}from"./SectionTitleLineWithButton.39476921.js";import{_ as A}from"./BaseButton.b8e12a74.js";import{p as ye,c as ge,u as we,v as xe,h as ke,y as Se,z as Ie}from"./mdi.aa269c9f.js";import{A as E}from"./index.77c7a69c.js";import{u as Ce}from"./supplier.a4b9a58c.js";import{u as Pe}from"./warehouse.0c6d3805.js";import{u as $e}from"./item.aee657f4.js";import"./darkMode.b88882a1.js";import"./BaseIcon.ad3a4017.js";import"./FormControl.2759acc3.js";import"./FooterBar.948c11c8.js";import"./logo.c6f18b48.js";import"./BaseLevel.e0eed931.js";import"./TableCheckboxCell.8ab5003b.js";import"./BaseButtons.e7208c74.js";import"./_plugin-vue_export-helper.c27b6911.js";const F={async create(n){return(await N.post(`${E}/procurements`,n)).data},async getById(n){return(await N.get(`${E}/procurements/${n}`)).data},async updateById(n,f){return(await N.put(`${E}/procurements/${n}`,f)).data},async delete(n){return(await N.delete(`${E}/procurements/${n}`)).data},async list(n){return(await N.get(`${E}/procurements`,{params:n})).data},async complete(n){return(await N.put(`${E}/procurements/${n}/complete`)).data}},Be=de("procurement",()=>{const n=y({total:0,totalPages:1,currentPage:1,pageSize:10,data:[]}),f=y(null),u=y(!1),p=y(null),_=y(!1);return{items:n,item:f,isLoading:u,error:p,isLoaded:_,fetchItems:async(d={},v=!1)=>{var a;if(p.value=null,!(!v&&_.value))try{u.value=!0;const m=await F.list(d);Object.assign(n.value,{total:m.total||0,totalPages:m.totalPages||1,currentPage:d.page||1,pageSize:d.limit||10,data:m.data||[]}),_.value=!0}catch(m){p.value=((a=m==null?void 0:m.response)==null?void 0:a.message)||"Failed to fetch procurements"}finally{u.value=!1}},fetchItemById:async d=>{var v;p.value=null;try{u.value=!0;const a=await F.getById(d);f.value=a}catch(a){p.value=((v=a==null?void 0:a.response)==null?void 0:v.message)||"Failed to fetch procurement"}finally{u.value=!1}},createItem:async d=>{var v;p.value=null;try{u.value=!0;const a=await F.create(d);n.value.data.push(a),n.value.total+=1}catch(a){p.value=((v=a==null?void 0:a.response)==null?void 0:v.message)||"Failed to create procurement"}finally{u.value=!1}},updateItem:async(d,v)=>{var a;p.value=null;try{u.value=!0;const m=await F.updateById(d,v),V=n.value.data.findIndex(z=>z.id===d);V!==-1&&(n.value.data[V]=m)}catch(m){p.value=((a=m==null?void 0:m.response)==null?void 0:a.message)||"Failed to update procurement"}finally{u.value=!1}},deleteItem:async d=>{var v;p.value=null;try{u.value=!0,await F.delete(d),n.value.data=n.value.data.filter(a=>a.id!==d),n.value.total-=1}catch(a){p.value=((v=a==null?void 0:a.response)==null?void 0:v.message)||"Failed to delete procurement"}finally{u.value=!1}},completeItem:async d=>{var v;p.value=null;try{u.value=!0;const a=await F.complete(d),m=n.value.data.findIndex(V=>V.id===d);m!==-1&&(n.value.data[m]=a)}catch(a){p.value=((v=a==null?void 0:a.response)==null?void 0:v.message)||"Failed to complete procurement"}finally{u.value=!1}},resetStore:()=>{n.value={total:0,totalPages:1,currentPage:1,pageSize:10,data:[]},f.value=null,_.value=!1,u.value=!1,p.value=null}}}),Ve={class:"flex items-center gap-2"},Ae={class:"flex gap-2"},De={key:0,class:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"},Ne={class:"bg-white p-6 rounded shadow-lg w-[600px] relative"},Ue=e("h2",{class:"text-xl mb-4"},"Add Procurement",-1),qe={class:"mb-4"},Ee=e("label",{class:"block mb-1"},"Supplier",-1),Fe=e("option",{value:""},"Select Supplier",-1),Le=["value"],Me={class:"mb-4"},Oe=e("label",{class:"block mb-1"},"Warehouse",-1),ze=e("option",{value:""},"Select Warehouse",-1),Te=["value"],je={class:"mb-4 relative"},Qe=e("label",{class:"block mb-1"},"Items",-1),We={class:"flex gap-2 mb-2"},Je={key:0,class:"absolute z-50 border p-2 mt-1 rounded bg-white max-h-48 overflow-y-auto w-full"},Ke=["onClick"],Re={class:"w-full border mt-2"},Ye=e("thead",{class:"bg-gray-200"},[e("tr",null,[e("th",{class:"p-2"},"Item Name"),e("th",{class:"p-2"},"Quantity"),e("th",{class:"p-2"},"Purchase Cost"),e("th",{class:"p-2"},"Amount"),e("th",{class:"p-2"},"Action")])],-1),Ge={class:"p-2"},He={class:"p-2 w-24"},Xe=["onUpdate:modelValue"],Ze={class:"p-2 w-24"},et={class:"p-2 w-24"},tt={class:"p-2 w-16 text-center"},st=["onClick"],at={key:1,class:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"},ot={class:"bg-white p-6 rounded shadow-lg w-[600px] relative"},lt=e("h2",{class:"text-xl mb-4"},"Edit Procurement",-1),nt={class:"mb-4"},rt=e("label",{class:"block mb-1"},"Supplier",-1),it=e("option",{value:""},"Select Supplier",-1),ut=["value"],ct={class:"mb-4"},dt=e("label",{class:"block mb-1"},"Warehouse",-1),mt=e("option",{value:""},"Select Warehouse",-1),pt=["value"],_t={class:"mb-4"},vt=e("label",{class:"block mb-1"},"Procurement Date",-1),ht={class:"mb-4 relative"},ft=e("label",{class:"block mb-1"},"Items",-1),bt={class:"flex gap-2 mb-2"},yt={key:0,class:"absolute z-50 border p-2 mt-1 rounded bg-white max-h-48 overflow-y-auto w-full"},gt=["onClick"],wt={class:"w-full border mt-2"},xt=e("thead",{class:"bg-gray-200"},[e("tr",null,[e("th",{class:"p-2"},"Item Name"),e("th",{class:"p-2"},"Quantity"),e("th",{class:"p-2"},"Purchase Cost"),e("th",{class:"p-2"},"Amount"),e("th",{class:"p-2"},"Action")])],-1),kt={class:"p-2"},St={class:"p-2 w-24"},It=["onUpdate:modelValue"],Ct={class:"p-2 w-24"},Pt={class:"p-2 w-24"},$t={class:"p-2 w-16 text-center"},Bt=["onClick"],Vt={key:2,class:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"},At={class:"bg-white p-4 rounded shadow-lg w-[400px]"},Dt=e("h2",{class:"text-lg font-bold mb-2"},"Procurement Details",-1),Nt={class:"mb-2 text-sm"},Ut=e("strong",null,"Supplier:",-1),qt={class:"mb-2 text-sm"},Et=e("strong",null,"Warehouse:",-1),Ft={class:"mb-2 text-sm"},Lt=e("strong",null,"Date:",-1),Mt={class:"mb-2 text-sm"},Ot=e("strong",null,"Status:",-1),zt={class:"mb-2 text-sm"},Tt=e("strong",null,"Items:",-1),jt={class:"w-full mt-1 text-xs border"},Qt=e("thead",null,[e("tr",{class:"bg-gray-200"},[e("th",{class:"p-1 border"},"Item"),e("th",{class:"p-1 border"},"Qty"),e("th",{class:"p-1 border"},"Cost"),e("th",{class:"p-1 border"},"Amt")])],-1),Wt={class:"p-1 border"},Jt={class:"p-1 border"},Kt={class:"p-1 border"},Rt={class:"p-1 border"},fs={__name:"ProcurementView",setup(n){const f=y(!1),u=y(!1),p=y(!1),_=y({supplier_id:"",items:[],warehouse_id:"",procurement_date:new Date().toISOString().slice(0,10),status:"pending"}),g=y(""),h=y({id:null,supplier_id:"",items:[],warehouse_id:"",procurement_date:"",status:""}),x=y(""),k=y({}),D=y([]),c=Be(),j=Ce(),d=Pe(),v=$e();async function a(s={},o=!1){await c.fetchItems(s,o)}a({page:1,limit:10}),me(async()=>{await j.fetchItems({page:1,limit:100},!0),await d.fetchAll({page:1,limit:100},!0),await v.fetchItems({page:1,limit:100},!0)});const m=U(()=>{var s,o,t,b,$;return{total:((s=c.items)==null?void 0:s.total)||0,totalPages:((o=c.items)==null?void 0:o.totalPages)||1,currentPage:((t=c.items)==null?void 0:t.currentPage)||1,pageSize:((b=c.items)==null?void 0:b.pageSize)||10,data:(($=c.items)==null?void 0:$.data)||[]}}),V=U(()=>j.items.data),z=U(()=>d.warehouses),K=U(()=>v.items.data),Q=U(()=>g.value?K.value.filter(s=>s.name.toLowerCase().includes(g.value.toLowerCase())):[]),W=U(()=>x.value?K.value.filter(s=>s.name.toLowerCase().includes(x.value.toLowerCase())):[]),R=[{key:"supplier",label:"Supplier",formatter:(s,o)=>o.supplier?o.supplier.name:""},{key:"warehouse",label:"Warehouse",formatter:(s,o)=>o.warehouse?o.warehouse.name:""},{key:"procurement_date",label:"Date",sortable:!0,filterable:!0,formatter:(s,o)=>o.procurement_date?new Date(o.procurement_date).toLocaleString():""},{key:"status",label:"Status",sortable:!0,filterable:!0}],Y=async s=>{await a(s,!0)},G=s=>{D.value=s},H=s=>{h.value={id:s.id,supplier_id:s.supplier_id,warehouse_id:s.warehouse_id,procurement_date:s.procurement_date?new Date(s.procurement_date).toISOString().slice(0,16):"",status:s.status,items:s.items?s.items:[]},u.value=!0};async function X(){await c.updateItem(h.value.id,h.value),c.error||(u.value=!1,await a({page:1,limit:10},!0))}function Z(){u.value=!1}const ee=()=>{_.value={supplier_id:"",items:[],warehouse_id:"",procurement_date:new Date().toISOString().slice(0,10),status:"pending"},g.value="",f.value=!0};async function te(){_.value.items.forEach((s,o)=>{s.item_id||console.error(`Item at index ${o} is missing item_id:`,s)}),await c.createItem(_.value),c.error||(f.value=!1,await a({page:1,limit:10},!0))}function se(){if(!g.value)return;const s=Q.value[0];if(s&&!_.value.items.find(t=>t.item_id===s.id)){const t={item_id:s.id,name:s.name,quantity:1,purchase_cost:0};console.log("Adding item:",t),_.value.items.push(t)}g.value=""}function ae(s){_.value.items.splice(s,1)}function oe(){if(!x.value)return;const s=W.value[0];if(s&&!h.value.items.find(t=>t.item_id===s.id)){const t={item_id:s.id,name:s.name,quantity:1,purchase_cost:0};h.value.items.push(t)}x.value=""}function le(s){h.value.items.splice(s,1)}async function ne(){if(D.value.length===0)return;if((await J.fire({title:"Are you sure?",text:"This action cannot be undone!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete them!"})).isConfirmed){for(const o of D.value)if(await c.deleteItem(o),c.error)break;c.error||(D.value=[],await a({page:1,limit:10},!0),J.fire("Deleted!","The procurements have been deleted.","success"))}}async function re(s){await c.completeItem(s.id),c.error||(await a({page:1,limit:10},!0),J.fire("Approved!","The procurement has been approved.","success"))}function ie(s){k.value=s,p.value=!0}function ue(){p.value=!1}function ce(){f.value=!1}return(s,o)=>(l(),L(pe,null,{default:q(()=>[B(_e,null,{default:q(()=>[w(c).error?(l(),L(ve,{key:0,icon:w(ye),color:"danger"},{default:q(()=>[M(i(w(c).error),1)]),_:1},8,["icon"])):S("",!0),B(be,{icon:w(ge),title:"Procurements",main:""},{default:q(()=>[e("div",Ve,[B(A,{icon:w(we),color:"primary",label:"New Procurement",onClick:ee},null,8,["icon"]),D.value.length?(l(),L(A,{key:0,icon:w(xe),color:"danger",label:"Delete",onClick:ne},null,8,["icon"])):S("",!0)])]),_:1},8,["icon"]),B(fe,{class:"mb-6"},{default:q(()=>[B(he,{columns:R,data:m.value,total:m.value.total,loading:w(c).isLoading,checkable:"",onQueryChange:Y,onSelected:G},{"cell-actions":q(({row:t})=>[e("div",Ae,[B(A,{icon:w(ke),color:"primary",onClick:b=>ie(t)},null,8,["icon","onClick"]),t.status!=="received"?(l(),L(A,{key:0,icon:w(Se),color:"primary",onClick:b=>H(t)},null,8,["icon","onClick"])):S("",!0),t.status!=="received"?(l(),L(A,{key:1,icon:w(Ie),color:"primary",onClick:b=>re(t)},null,8,["icon","onClick"])):S("",!0)])]),_:1},8,["data","total","loading"])]),_:1})]),_:1}),f.value?(l(),r("div",De,[e("div",Ne,[Ue,e("div",qe,[Ee,I(e("select",{"onUpdate:modelValue":o[0]||(o[0]=t=>_.value.supplier_id=t),class:"w-full border p-2 rounded"},[Fe,(l(!0),r(C,null,P(V.value,t=>(l(),r("option",{key:t.id,value:t.id},i(t.name),9,Le))),128))],512),[[T,_.value.supplier_id]])]),e("div",Me,[Oe,I(e("select",{"onUpdate:modelValue":o[1]||(o[1]=t=>_.value.warehouse_id=t),class:"w-full border p-2 rounded"},[ze,(l(!0),r(C,null,P(z.value,t=>(l(),r("option",{key:t.id,value:t.id},i(t.name),9,Te))),128))],512),[[T,_.value.warehouse_id]])]),e("div",je,[Qe,e("div",We,[I(e("input",{"onUpdate:modelValue":o[2]||(o[2]=t=>g.value=t),type:"text",placeholder:"Search item by name",class:"w-full border p-2 rounded"},null,512),[[O,g.value]]),B(A,{label:"Add",color:"primary",onClick:se})]),g.value&&Q.value.length?(l(),r("div",Je,[e("ul",null,[(l(!0),r(C,null,P(Q.value,t=>(l(),r("li",{key:t.id,class:"cursor-pointer hover:bg-gray-100 p-1",onClick:()=>{_.value.items.find(b=>b.item_id===t.id)||_.value.items.push({item_id:t.id,name:t.name,quantity:1,purchase_cost:t.cost}),g.value=""}},i(t.name),9,Ke))),128))])])):S("",!0),e("table",Re,[Ye,e("tbody",null,[(l(!0),r(C,null,P(_.value.items,(t,b)=>(l(),r("tr",{key:t.item_id,class:"border-b"},[e("td",Ge,i(t.name),1),e("td",He,[I(e("input",{type:"number",min:"1",class:"border p-1 w-full","onUpdate:modelValue":$=>t.quantity=$},null,8,Xe),[[O,t.quantity,void 0,{number:!0}]])]),e("td",Ze,i(t.purchase_cost),1),e("td",et,i((t.quantity||0)*(t.purchase_cost||0)),1),e("td",tt,[e("button",{class:"text-red-500",onClick:$=>ae(b)},"×",8,st)])]))),128))])])]),e("div",{class:"flex justify-end space-x-2 mt-4"},[e("button",{class:"px-4 py-2 bg-gray-200 rounded",onClick:ce}," Cancel "),e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded",onClick:te}," Save ")])])])):S("",!0),u.value?(l(),r("div",at,[e("div",ot,[lt,e("div",nt,[rt,I(e("select",{"onUpdate:modelValue":o[3]||(o[3]=t=>h.value.supplier_id=t),class:"w-full border p-2 rounded"},[it,(l(!0),r(C,null,P(V.value,t=>(l(),r("option",{key:t.id,value:t.id},i(t.name),9,ut))),128))],512),[[T,h.value.supplier_id]])]),e("div",ct,[dt,I(e("select",{"onUpdate:modelValue":o[4]||(o[4]=t=>h.value.warehouse_id=t),class:"w-full border p-2 rounded"},[mt,(l(!0),r(C,null,P(z.value,t=>(l(),r("option",{key:t.id,value:t.id},i(t.name),9,pt))),128))],512),[[T,h.value.warehouse_id]])]),e("div",_t,[vt,I(e("input",{"onUpdate:modelValue":o[5]||(o[5]=t=>h.value.procurement_date=t),type:"datetime-local",class:"w-full border p-2 rounded"},null,512),[[O,h.value.procurement_date]])]),e("div",ht,[ft,e("div",bt,[I(e("input",{"onUpdate:modelValue":o[6]||(o[6]=t=>x.value=t),type:"text",placeholder:"Search item by name",class:"w-full border p-2 rounded"},null,512),[[O,x.value]]),B(A,{label:"Add",color:"primary",onClick:oe})]),x.value&&W.value.length?(l(),r("div",yt,[e("ul",null,[(l(!0),r(C,null,P(W.value,t=>(l(),r("li",{key:t.id,class:"cursor-pointer hover:bg-gray-100 p-1",onClick:()=>{h.value.items.find(b=>b.item_id===t.id)||h.value.items.push({item_id:t.id,name:t.name,quantity:1,purchase_cost:0}),x.value=""}},i(t.name),9,gt))),128))])])):S("",!0),e("table",wt,[xt,e("tbody",null,[(l(!0),r(C,null,P(h.value.items,(t,b)=>(l(),r("tr",{key:t.item_id,class:"border-b"},[e("td",kt,i(t.item.name),1),e("td",St,[I(e("input",{type:"number",min:"1",class:"border p-1 w-full","onUpdate:modelValue":$=>t.quantity=$},null,8,It),[[O,t.quantity,void 0,{number:!0}]])]),e("td",Ct,i(t.item.cost),1),e("td",Pt,i((t.quantity||0)*(t.item.cost||0)),1),e("td",$t,[e("button",{class:"text-red-500",onClick:$=>le(b)},"×",8,Bt)])]))),128))])])]),e("div",{class:"flex justify-end space-x-2 mt-4"},[e("button",{class:"px-4 py-2 bg-gray-200 rounded",onClick:Z}," Cancel "),e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded",onClick:X}," Save Changes ")])])])):S("",!0),p.value?(l(),r("div",Vt,[e("div",At,[Dt,e("div",Nt,[Ut,M(" "+i(k.value.supplier?k.value.supplier.name:"N/A"),1)]),e("div",qt,[Et,M(" "+i(k.value.warehouse?k.value.warehouse.name:"N/A"),1)]),e("div",Ft,[Lt,M(" "+i(k.value.procurement_date),1)]),e("div",Mt,[Ot,M(" "+i(k.value.status),1)]),e("div",zt,[Tt,e("table",jt,[Qt,e("tbody",null,[(l(!0),r(C,null,P(k.value.items,(t,b)=>(l(),r("tr",{key:b,class:"border-b"},[e("td",Wt,i(t.item.name),1),e("td",Jt,i(t.quantity),1),e("td",Kt,i(t.cost),1),e("td",Rt,i((t.quantity||0)*(t.cost||0)),1)]))),128))])])]),e("div",{class:"flex justify-end mt-2"},[e("button",{class:"px-3 py-1 bg-blue-600 text-white rounded text-xs",onClick:ue}," Close ")])])])):S("",!0)]),_:1}))}};export{fs as default};
